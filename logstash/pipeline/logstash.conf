input {
	beats {
		port => 5044
	}
}

## Add your filters / logstash plugins configuration here
filter {
  if [@metadata][beat] == "metricbeat" {

    # Gắn tag SIEM cho mọi log từ metricbeat
    mutate {
      add_tag => ["metricbeat", "siem"]
    }

    ###############################
    # 1. Module beat (giám sát Beat khác)
    ###############################
    if [event][module] == "beat" {
      mutate {
        add_tag => ["beat_monitoring"]
      }

      #################################
      # a. Metricset: stats
      #################################
      if [metricset][name] == "stats" {
        mutate {
          add_tag => ["beat_stats"]
          rename => {
            "[beat][name]"         => "beat_name"
            "[beat][type]"         => "beat_type"
            "[beat][uuid]"         => "beat_uuid"
            "[beat][version]"      => "beat_version"
            "[beat][host]"         => "beat_host"
            "[beat][ephemeral_id]" => "beat_ephemeral_id"
            "[system][cpu][total][pct]" => "cpu_usage_pct"
          }
        }

        # Tùy chọn: chuẩn hóa timestamp
        date {
          match => ["@timestamp", "ISO8601"]
        }
      }

      #################################
      # b. Metricset: state
      #################################
      if [metricset][name] == "state" {
        mutate {
          add_tag => ["beat_state"]
          rename => {
            "[beat_state][host]"        => "beat_state_host"
            "[beat_state][output][type]" => "beat_output_type"
            "[beat_state][output][name]" => "beat_output_name"
          }
        }
      }
    }

    ###############################
    # 2. Xử lý các module khác (cpu, memory, system, docker,...)
    ###############################
    else {
      mutate {
        add_tag => ["system_metrics"]
      }
      if [system][cpu] {
        mutate {
          rename => {
            "[system][cpu][total][pct]" => "system_cpu_usage_pct"
          }
        }
      }

      if [system][memory] {
        mutate {
          rename => {
            "[system][memory][used][pct]" => "system_memory_used_pct"
          }
        }
      }

      if [host][hostname] {
        mutate {
          rename => {
            "[host][hostname]" => "host_name"
          }
        }
      }
    }

    ###############################
    # 3. Chuẩn hóa format cho SIEM
    ###############################
    mutate {
      lowercase => [ "beat_type", "beat_output_type", "beat_name" ]
    }

    # bỏ những trường rác, không cần thiết
    mutate {
      remove_field => ["agent", "ecs", "input", "meta"]
    }
  }
}

output {
  elasticsearch {
    hosts => "elasticsearch:9200"
    user => "elastic"
    password => "${LOGSTASH_INTERNAL_PASSWORD}"
    data_stream => true
  }
}
